# DMA Samples
Rust-DOCA provide two samples for users to be familiar with DOCA DMA SDK(actually they're just been ported from the `C` version given by
the SDK).

## local_dma_copy
**This sample should only be running on DPU!!**

`local_dma_copy` is a sample that uses DOCA DMA to copy the content from one buffer on DPU to another buffer on DPU. It needs some arguments which we can see from 
`cargo run --example local_dma_copy -- --help`
```Bash
$ cargo run --example local_dma_copy -- --help
doca dma local copy 0.1
Yuhan Yang
The doca dma local copy samples on DPU

USAGE:
    local_copy_on_dpu [OPTIONS] --pci <DEV_PCI>

OPTIONS:
    -h, --help                    Print help information
        --pci <DEV_PCI>           DOCA DMA Device PCI address
        --txt [<COPY_TEXT>...]    The text to be delivered
    -V, --version                 Print version information
```
The first parameter is `pci` which should be a DOCA DMA Device PCI address which the user can
get from the command `lspci | grep Mellanox` this doc mentioned above. The second parameter 
is `txt`, which is the text which the user want to deliver between the source buffer and 
the destination buffer.

Use command like 
`cargo run --example local_dma_copy -- --pci "03:00.0" --txt "Hello World!"` to run 
the example. For more detail, please refer to the comments in the code.

Notice that the DMA request should **only be delivered by DPU**, the sample should be running on DPU rather than Host.

## dma_copy
**dma_copy_host should be running before dma_copy_dpu!!**

This sample uses DOCA DMA to copy a buffer from Host to DPU. It also needs some 
arguments we can see from command `cargo run --example dma_copy_host -- --help`
```Bash
$ cargo run --example dma_copy_host -- --help
doca dma copy 0.1
Yuhan Yang
The doca dma copy samples on Host Side

USAGE:
    dma_copy_host [OPTIONS] --pci <DEV_PCI> --export <FILE_PATH> --buffer <FILE_PATH>

OPTIONS:
        --buffer <FILE_PATH>      buffer info file path
        --export <FILE_PATH>      export descriptor file path
    -h, --help                    Print help information
        --pci <DEV_PCI>           DOCA DMA Device PCI address
        --txt [<COPY_TEXT>...]    The text to be delivered
    -V, --version                 Print version information
```
It needs the same parameters like `local_copy_on_dpu`, a DOCA Device PCI address & a 
text delivered. It needs extra parameters `buffer` and `export` to decide whether to
store the information needed to construct a remote MemoryPool on the other side.
After all the initialization is done, the user need to transfer these two files to the DPU side
(simply using `scp` is recommended).

The DPU side`s parameter can be seen below.
```Bash 
$ cargo run --example dma_copy_dpu -- --help
doca dma copy 0.1
Yuhan Yang
The doca dma copy samples on DPU

USAGE:
    dma_copy_dpu --pci <DEV_PCI> --export <FILE_PATH> --buffer <FILE_PATH>

OPTIONS:
        --buffer <FILE_PATH>    buffer info file path
        --export <FILE_PATH>    export descriptor file path
    -h, --help                  Print help information
        --pci <DEV_PCI>         DOCA DMA Device PCI address
    -V, --version               Print version information
```

It needs the two file paths which the user transferred the file generated by Host before. 
Also, a device PCI address is needed.

Here is an example of running this sample.
```Bash
# Host side
$ cargo run --example dma_copy_host -- --pci "17:00.0" --txt "Hello World!" --export "/tmp/export.txt" --buffer "/tmp/buffer.txt"
# and transfer these two files using `scp`, the user might use another ssh session since the program is blocking.
$ scp /tmp/export.txt /tmp/buffer.txt snic-pro0:/tmp/

# DPU side
$ cargo run --example dma_copy_dpu -- --pci "03:00.0" --export "/tmp/export.txt" --buffer "/tmp/buffer.txt"
```

The user will see `dma copy success, the information in dst buffer: Hello World!` from the DPU
side if the DMA request is successful. For more detail, please refer to the comments in 
the code.
